@page "/profile"
@using Booktique.Models.MainModels
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Booktique.Components.Pages.Account.Charts

@inject BooktiqueContext DbContext
@inject NavigationManager NavigationManager
@inject IHttpContextAccessor HttpContextAccessor

@rendermode InteractiveServer
@attribute [Authorize]

<PageTitle>My Profile | Booktique</PageTitle>

<div class="profile-page-wrapper">
    <div class="container py-5">
        @if (user == null)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-warning" role="status"></div>
                <p class="mt-2">Loading your bookish world...</p>
            </div>
        }
        else
        {
            <div class="row g-4">
                <div class="col-lg-4">
                    <div class="profile-card shadow-lg border-0">
                        <div class="avatar-section">
                            <div class="avatar-wrapper shadow">
                                <img src="@(string.IsNullOrEmpty(user.ProfilePicture) ? defaultAvatar : user.ProfilePicture)"
                                     alt="Profile Picture" class="profile-avatar-img" />
                                <button class="change-avatar-btn" @onclick="ToggleAvatarPicker">
                                    <i class="bi bi-camera-fill"></i>
                                </button>
                            </div>
                            <h3 class="mt-3 fw-bold">@user.UserName</h3>
                            <span class="badge rounded-pill bg-light text-brown border px-3">@user.Role</span>
                        </div>

                        <div class="info-section mt-4 px-3">
                            <div class="info-item border-bottom py-2 d-flex justify-content-between">
                                <span class="text-muted"><i class="bi bi-envelope me-2"></i>Email</span>
                                <span class="fw-medium">@user.UserEmail</span>
                            </div>
                        </div>

                        <div class="actions-section mt-4 d-grid gap-2 p-3">
                            <button class="btn btn-warning shadow-sm" @onclick="EditProfile">
                                <i class="bi bi-pencil-square me-2"></i>Edit Information
                            </button>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary w-100" @onclick="Logout">
                                    <i class="bi bi-box-arrow-right me-1"></i>Logout
                                </button>
                                <button class="btn btn-outline-danger w-100" @onclick="Delete">
                                    <i class="bi bi-trash me-1"></i>Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-8">
                    <div class="stats-card shadow-lg border-0 p-4 h-100">
                        <div class="d-flex align-items-center mb-4">
                            <div class="stats-icon me-3">📊</div>
                            <h2 class="mb-0 fw-bold text-brown">Personal Reading Stats</h2>
                        </div>
                        <hr />
                        <div class="chart-container py-4">
                            <GenreChart @key="chartKey" />
                        </div>
                    </div>
                </div>
            </div>

            @if (showAvatarPicker)
            {
                <div class="avatar-modal-overlay" @onclick="ToggleAvatarPicker">
                    <div class="avatar-modal-content card shadow-xl p-4" @onclick:stopPropagation="true">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="mb-0 fw-bold">Choose your Avatar</h4>
                            <button class="btn-close" @onclick="ToggleAvatarPicker"></button>
                        </div>
                        <div class="avatar-grid">
                            @foreach (var avatarUrl in availableAvatars)
                            {
                                <div class="avatar-option @(user.ProfilePicture == avatarUrl ? "selected" : "")"
                                     @onclick="() => SelectAvatar(avatarUrl)">
                                    <img src="@avatarUrl" alt="Avatar option" />
                                    @if (user.ProfilePicture == avatarUrl)
                                    {
                                        <div class="check-mark"><i class="bi bi-check-lg"></i></div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>

<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        background-color: #fdf6ee;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    :root {
        --brown-primary: #5a3e2b;
        --brown-hover: #4a3324;
        --cream-bg: #fdf6ee;
    }

    .profile-page-wrapper {
        background-color: var(--cream-bg);
        min-height: 100vh;
    }

    .text-brown {
        color: var(--brown-primary);
    }

    .btn-brown {
        background-color: var(--brown-primary);
        color: white;
    }

        .btn-brown:hover {
            background-color: var(--brown-hover);
            color: white;
        }

    .profile-card, .stats-card {
        background: white;
        border-radius: 20px;
        overflow: hidden;
    }

    .avatar-section {
        background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
        padding: 3rem 1rem 1rem;
        text-align: center;
    }

    .avatar-wrapper {
        position: relative;
        width: 160px;
        height: 160px;
        margin: 0 auto;
        border-radius: 50%;
        padding: 5px;
        background: white;
    }

    .profile-avatar-img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }

    .change-avatar-btn {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background: var(--brown-primary);
        color: white;
        border: 3px solid white;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
    }

        .change-avatar-btn:hover {
            transform: scale(1.1);
        }

    .avatar-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1050;
    }

    .avatar-modal-content {
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        border-radius: 20px;
    }

    .avatar-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
    }

    .avatar-option {
        cursor: pointer;
        border-radius: 15px;
        padding: 5px;
        border: 3px solid transparent;
        transition: all 0.2s;
        position: relative;
    }

        .avatar-option:hover {
            background: var(--cream-bg);
        }

        .avatar-option.selected {
            border-color: var(--brown-primary);
        }

        .avatar-option img {
            width: 100%;
            border-radius: 10px;
        }

    .check-mark {
        position: absolute;
        top: -5px;
        right: -5px;
        background: var(--brown-primary);
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .stats-icon {
        font-size: 2.5rem;
    }
</style>

@code {
    private User? user;
    private Guid chartKey = Guid.NewGuid();
    private bool showAvatarPicker = false;

    [CascadingParameter]
    public HttpContext HttpContext { get; set; }

    // Imaginea default cerută de tine
    private string defaultAvatar = "https://www.shutterstock.com/image-illustration/man-open-book-illustration-element-260nw-1103282219.jpg";

    // Listă de avatare din care utilizatorul poate alege
    private List<string> availableAvatars = new()
    {
        "https://cdn-icons-png.flaticon.com/512/2702/2702134.png", // Băiat citind (copertă roșie)
        "https://cdn-icons-png.flaticon.com/512/2702/2702069.png", // Fată citind (copertă verde)
        "https://cdn-icons-png.flaticon.com/512/3532/3532840.png", // Fată citind relaxată (galben)
        "https://cdn-icons-png.flaticon.com/512/201/201623.png",   // Doar cărțile (pentru cine vrea ceva neutru)
        "https://cdn-icons-png.flaticon.com/512/1903/1903162.png", // Personaj cu ochelari și carte
        "https://cdn-icons-png.flaticon.com/512/1903/1903177.png", // Cititoare entuziasmată
        "https://cdn-icons-png.flaticon.com/512/167/167756.png", // Student cu teanc de cărți
        "https://cdn-icons-png.flaticon.com/512/1903/1903172.png", // Cititor pe fotoliu
        "https://cdn-icons-png.flaticon.com/512/2232/2232688.png", // Cititor la fereastră
        "https://www.shutterstock.com/image-illustration/man-open-book-illustration-element-260nw-1103282219.jpg" // Originalul (Default)
    };

    protected override async Task OnInitializedAsync()
    {
        var username = HttpContextAccessor.HttpContext?.User?.Identity?.Name;
        if (string.IsNullOrWhiteSpace(username))
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        user = await DbContext.User.FirstOrDefaultAsync(u => u.UserName == username);
        if (user == null) NavigationManager.NavigateTo("/notfound");
    }

    private void ToggleAvatarPicker() => showAvatarPicker = !showAvatarPicker;

    private async Task SelectAvatar(string url)
    {
        if (user != null)
        {
            user.ProfilePicture = url;
            DbContext.User.Update(user);
            await DbContext.SaveChangesAsync();
            showAvatarPicker = false;
        }
    }

    protected override void OnParametersSet()
    {
        chartKey = Guid.NewGuid(); // forțează re-rendere completă
    }

    private void EditProfile() => NavigationManager.NavigateTo($"/users/edit?userid={user?.UserId}");
    private void Logout() => NavigationManager.NavigateTo("/logout");
    private void Delete() => NavigationManager.NavigateTo("/delete");
}