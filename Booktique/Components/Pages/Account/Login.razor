@page "/login"
@using Booktique.Models.ViewModels
@using Booktique.Models
@using System.Security.Claims
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies

@inject BooktiqueContext appContext
@inject NavigationManager NavigationManager

<PageTitle>Login | Booktique</PageTitle>

<div class="login-page-wrapper d-flex justify-content-center">
    <div class="login-container mt-5">
        <div class="login-card shadow-lg border-0">

            <div class="card-body p-4">
                <div class="text-center mb-4">
                    <div class="gif-wrapper mb-3">
                        <img src="https://usagif.com/wp-content/uploads/gifs/book-90.gif" alt="Book opening" class="book-gif" />
                    </div>
                    <h3 class="fw-bold text-brown mb-1">Welcome Back</h3>
                    <p class="text-muted small">Access your Booktique account</p>
                </div>

                <EditForm Model="@Model" OnValidSubmit="Authenticate" FormName="loginForm">
                    <DataAnnotationsValidator />

                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="bi bi-person text-brown"></i></span>
                            <InputText @bind-Value="Model.UserName" class="form-control border-start-0 ps-0" placeholder="Username" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="bi bi-envelope text-brown"></i></span>
                            <InputText @bind-Value="Model.UserEmail" class="form-control border-start-0 ps-0" placeholder="Email" />
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="bi bi-lock text-brown"></i></span>
                            <InputText @bind-Value="Model.Password" type="password" class="form-control border-start-0 ps-0" placeholder="Password" />
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-warning py-2 fw-bold rounded-pill">SIGN IN</button>

                        <div class="separator d-flex align-items-center text-center my-2">
                            <span class="w-100 border-bottom"></span>
                            <span class="px-3 small text-muted">OR</span>
                            <span class="w-100 border-bottom"></span>
                        </div>

                        <a class="btn btn-outline-dark py-2 rounded-pill d-flex align-items-center justify-content-center gap-2" href="/ExternalLogin/SignInWithGoogle">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18" alt="Google" />
                            Continue with Google
                        </a>
                    </div>
                </EditForm>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger py-2 mt-3 mb-0 small text-center">
                        @errorMessage
                    </div>
                }

                <div class="mt-4 text-center">
                    <p class="small mb-0">
                        Don't have an account?
                        <NavLink href="/users/create" class="text-brown fw-bold text-decoration-none">Sign up</NavLink>
                    </p>
                </div>
            </div>

            <div class="py-3 text-center border-top bg-light">
                <p class="quote-mini mb-0">“A room without books is like a body without a soul.”</p>
            </div>
        </div>
    </div>
</div>

<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        background-color: #fdf6ee;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    :root {
        --brown-primary: #5a3e2b;
        --brown-hover: #4a3324;
        --cream-bg: #fdf6ee;
    }

    .login-page-wrapper {
        height: 100vh;
        overflow: hidden;
        background-color: var(--cream-bg);
    }

    .login-container {
        width: 100%;
        max-width: 400px;
    }

    .login-card {
        background: white;
        border-radius: 20px;
        overflow: hidden;
    }

    .gif-container {
        width: 70px;
        height: 70px;
        margin: 0 auto;
        overflow: hidden;
    }

    .book-gif {
        width: 100px;
        height: auto;
        display: block;
        margin: 0 auto;
        animation: fadeIn 1s ease-in-out;
    }

    .quote-mini {
        font-size: 0.75rem;
        color: #888;
        font-style: italic;
    }

    .btn-warning {
        color: white;
    }

    .text-brown {
        color: var(--brown-primary);
    }

    /* Input focus style */
    .form-control:focus {
        border-color: var(--brown-primary);
        box-shadow: none;
    }

    .input-group-text {
        border-color: #ced4da;
    }
</style>

@code {
    [CascadingParameter]
    public HttpContext? HttpContext { get; set; }

    [SupplyParameterFromForm]
    public LoginDTO Model { get; set; } = new();

    private string? errorMessage;

    private async Task Authenticate()
    {
        var user = appContext.User.FirstOrDefault(x => x.UserName == Model.UserName);

        if (user is null || user.Password != Model.Password)
        {
            errorMessage = "Invalid credentials. Please try again.";
            return;
        }

        var claims = new List<Claim>
        {
            new Claim(ClaimTypes.Name, Model.UserName),
            new Claim(ClaimTypes.NameIdentifier, user.UserId.ToString()),
            new Claim(ClaimTypes.Email, user.UserEmail ?? string.Empty),
            new Claim(ClaimTypes.Role, user.Role)
        };

        var identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
        var principal = new ClaimsPrincipal(identity);

        if (HttpContext != null)
        {
            await HttpContext.SignInAsync(principal);
            NavigationManager.NavigateTo("/");
        }
    }
}