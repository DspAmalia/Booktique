@page "/users/create"
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using Microsoft.EntityFrameworkCore
@using Booktique.Models.MainModels
@using Booktique.Models.DTO__Data_Transfer_Obj_
@using System.Security.Cryptography
@using System.Text
@using System.Security.Claims

@inject IDbContextFactory<BooktiqueContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Create Account | Booktique</PageTitle>

<div class="register-page-wrapper d-flex justify-content-center">
    <div class="register-container mt-5">
        <div class="register-card shadow-lg border-0">

            <div class="card-body p-4">
                <div class="text-center mb-4">
                    <div class="gif-wrapper mb-3">
                        <img src="https://usagif.com/wp-content/uploads/gifs/book-90.gif" alt="Book opening" class="book-gif" />
                    </div>
                    <h3 class="fw-bold text-brown mb-1">Join Booktique</h3>
                    <p class="text-muted small">Create an account to start your journey</p>
                </div>

                <EditForm Model="@NewUser" OnValidSubmit="AddUser" FormName="createForm">
                    <DataAnnotationsValidator />

                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="bi bi-person text-brown"></i></span>
                            <InputText id="username" @bind-Value="NewUser.UserName" class="form-control border-start-0 ps-0" placeholder="Username" />
                        </div>
                        <ValidationMessage For="() => NewUser.UserName" class="text-danger small" />
                    </div>

                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="bi bi-envelope text-brown"></i></span>
                            <InputText id="email" @bind-Value="NewUser.UserEmail" class="form-control border-start-0 ps-0" placeholder="Email" />
                        </div>
                        <ValidationMessage For="() => NewUser.UserEmail" class="text-danger small" />
                    </div>

                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="bi bi-lock text-brown"></i></span>
                            <InputText id="password" @bind-Value="NewUser.Password" type="password" class="form-control border-start-0 ps-0" placeholder="Password" />
                        </div>
                        <ValidationMessage For="() => NewUser.Password" class="text-danger small" />
                    </div>

                    <div class="mb-4">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="bi bi-shield-check text-brown"></i></span>
                            <InputText id="confirm-password" @bind-Value="NewUser.ConfirmPassword" type="password" class="form-control border-start-0 ps-0" placeholder="Confirm Password" />
                        </div>
                        <ValidationMessage For="() => NewUser.ConfirmPassword" class="text-danger small" />
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-warning py-2 fw-bold rounded-pill text-white">CREATE ACCOUNT</button>
                    </div>
                </EditForm>

                @if (!string.IsNullOrEmpty(ErrorMessage))
                {
                    <div class="alert alert-danger py-2 mt-3 mb-0 small text-center">
                        @ErrorMessage
                    </div>
                }

                <div class="mt-4 text-center">
                    <p class="small mb-0">
                        Already have an account?
                        <NavLink href="/login" class="text-brown fw-bold text-decoration-none">Log in</NavLink>
                    </p>
                </div>
            </div>

            <div class="py-3 text-center border-top bg-light">
                <p class="quote-mini mb-0">“Books are a uniquely portable magic.”</p>
            </div>
        </div>
    </div>
</div>

<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        background-color: #fdf6ee;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    :root {
        --brown-primary: #5a3e2b;
        --cream-bg: #fdf6ee;
    }

    .register-page-wrapper {
        min-height: 100vh;
        background-color: var(--cream-bg);
    }

    .register-container {
        width: 100%;
        max-width: 400px;
    }

    .register-card {
        background: white;
        border-radius: 20px;
        overflow: hidden;
    }

    .gif-container {
        width: 70px;
        height: 70px;
        margin: 0 auto;
        overflow: hidden;
    }

    .book-gif {
        width: 100px;
        height: auto;
        display: block;
        margin: 0 auto;
        animation: fadeIn 1s ease-in-out;
    }

    .text-brown {
        color: var(--brown-primary);
    }

    .btn-warning {
        background-color: #f4d03f;
        border: none;
    }

        .btn-warning:hover {
            background-color: #e2c035;
        }

    .form-control:focus {
        border-color: var(--brown-primary);
        box-shadow: none;
    }

    .input-group-text {
        border-color: #ced4da;
    }

    .quote-mini {
        font-size: 0.75rem;
        color: #888;
        font-style: italic;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

@code {
    [SupplyParameterFromForm]
    private RegisterDTO NewUser { get; set; } = new();
    
    [CascadingParameter]
    public HttpContext? HttpContext { get; set; }

    private string? ErrorMessage;

    private async Task AddUser()
    {
        if (NewUser.Password != NewUser.ConfirmPassword)
        {
            ErrorMessage = "Passwords do not match!";
            return;
        }

        using var context = DbFactory.CreateDbContext();
        
        // verific dacă email-ul există deja
        if (await context.User.AnyAsync(u => u.UserEmail == NewUser.UserEmail))
        {
            ErrorMessage = "Email already registered!";
            return;
        }

        //Setare automată a rolului
        var role = NewUser.UserName.Equals("admin", StringComparison.OrdinalIgnoreCase)
            ? "Administrator"
            : "User";

        var user = new User
            {
                UserName = NewUser.UserName,
                Password = NewUser.Password,
                Role = role,
                UserEmail=NewUser.UserEmail
            };

        context.User.Add(user);
        await context.SaveChangesAsync();

        var claims = new List<Claim>
        {
            new Claim(ClaimTypes.Name, user.UserName),
            new Claim(ClaimTypes.Role, user.Role),
            new Claim(ClaimTypes.Email, user.UserEmail)
        };

        var identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
        var principal = new ClaimsPrincipal(identity);
        await HttpContext.SignInAsync(principal);
        NavigationManager.NavigateTo("/");
    }

    // private string HashPassword(string password)
    // {
    //     using var sha = SHA256.Create();
    //     var bytes = Encoding.UTF8.GetBytes(password);
    //     var hash = sha.ComputeHash(bytes);
    //     return Convert.ToBase64String(hash);
    // }
}
