@page "/users"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using Booktique.Models.MainModels
@using static Booktique.Models.MainModels.User
@implements IAsyncDisposable
@inject IDbContextFactory<BooktiqueContext> DbFactory

@attribute [Authorize(Roles = "Administrator")]

<PageTitle>User Management | Booktique</PageTitle>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>User <strong>Management</strong></h2>
            <p class="text-muted">Overview of all registered members in Booktique</p>
        </div>
        <div class="d-flex gap-2">
            <a href="users/create" class="btn btn-warning rounded-pill px-4 shadow-sm">
                <i class="bi bi-person-plus-fill me-2"></i>Create New
            </a>
            <a href="/admin/dashboard" class="btn btn-outline-secondary rounded-pill px-4 shadow-sm">
                <i class="bi bi-arrow-left me-2"></i>Back
            </a>
        </div>
    </div>
    <hr />
    <div class="card shadow border-0 rounded-4 overflow-hidden">
        <div class="card-body p-0">
            <QuickGrid Class="table align-middle mb-0 custom-grid" Items="context.User">

                <TemplateColumn Title="Profile" Class="col-profile">
                    <img src="@(string.IsNullOrEmpty(context.ProfilePicture) ? "https://www.shutterstock.com/image-illustration/man-open-book-illustration-element-260nw-1103282219.jpg" : context.ProfilePicture)"
                         class="rounded-circle border shadow-sm"
                         style="width: 35px; height: 35px; object-fit: cover;" />
                </TemplateColumn>

                <PropertyColumn Title="Username" Property="user => user.UserName" Sortable="true" Class="fw-bold text-brown" />

                <PropertyColumn Title="Email" Property="user => user.UserEmail" Sortable="true" />

                <TemplateColumn Title="Role" Sortable="true">
                    @{
                        var roleClass = context.Role == "Administrator" ? "bg-danger" : "bg-brown";
                    }
                    <span class="badge @roleClass rounded-pill">@context.Role</span>
                </TemplateColumn>

                <TemplateColumn Title="Subscription Plan" Sortable="true" Class="col-subscribed">
                    @switch (context.IsSubscribed)
                    {
                        case SubscriptionLevel.Yearly:
                            <span class="badge rounded-pill bg-warning text-dark">
                                <i class="bi bi-star-fill me-1"></i> Yearly Premium
                            </span>
                            break;

                        case SubscriptionLevel.Monthly:
                            <span class="badge rounded-pill bg-info text-white">
                                <i class="bi bi-calendar-check-fill me-1"></i> Monthly
                            </span>
                            break;

                        case SubscriptionLevel.None:
                        default:
                            <span class="badge rounded-pill bg-light text-muted border">
                                <i class="bi bi-x-circle me-1"></i> No Active Plan
                            </span>
                            break;
                    }
                </TemplateColumn>

                <TemplateColumn Title="Actions" Class="text-end pe-4">
                    <div class="btn-group shadow-sm rounded-pill overflow-hidden">
                        <a href="@($"users/details?userid={context.UserId}")" class="btn btn-sm btn-light border" title="Details">
                            <i class="bi bi-eye-fill text-primary"></i>
                        </a>
                        <a href="@($"users/delete?userid={context.UserId}")" class="btn btn-sm btn-light border" title="Delete">
                            <i class="bi bi-trash-fill text-danger"></i>
                        </a>
                    </div>
                </TemplateColumn>
            </QuickGrid>
        </div>
    </div>
</div>

<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        background-color: #fdf6ee;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    :root {
        --brown-primary: #5a3e2b;
        --cream-bg: #fdf6ee;
    }

    body {
        background-color: var(--cream-bg);
    }

    .text-brown {
        color: var(--brown-primary);
    }

    .bg-brown {
        background-color: var(--brown-primary);
    }

    .btn-warning {
        color: white;
    }

    .custom-grid {
        width: 100%;
        border-collapse: collapse;
    }

    ::deep .table thead th {
        background-color: #f8f9fa !important;
        color: #888 !important;
        font-size: 0.7rem !important;
        text-transform: uppercase !important;
        letter-spacing: 1px !important;
        padding: 12px 15px !important;
        border-bottom: 2px solid #eee !important;
        text-align: left !important; 
    }

        ::deep .table thead th:last-child {
            text-align: right !important;
        }

    ::deep .table tbody td {
        padding: 12px 15px !important;
        border-bottom: 1px solid #f1f1f1 !important;
        vertical-align: middle !important;
        text-align: left !important; 
    }

    .col-profile {
        width: 80px;
    }

    .badge {
        padding: 0.5em 0.9em;
        font-size: 0.75rem;
    }

    ::deep .quickgrid {
        display: table; 
        width: 100%;
    }
</style>

@code {
    private BooktiqueContext context = default!;

    protected override void OnInitialized()
    {
        context = DbFactory.CreateDbContext();
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}