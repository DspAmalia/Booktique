@page "/users/edit"

@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Booktique.Models.MainModels

@inject IDbContextFactory<BooktiqueContext> DbFactory
@inject NavigationManager NavigationManager

@attribute [Authorize(Roles = "Administrator")]
@rendermode InteractiveServer

<PageTitle>Edit User | Booktique</PageTitle>

<div class="main-wrapper py-4">
    <div class="container">
        <div class="mb-4">
            <h2>Edit <strong>User Profile</strong></h2>
            <p class="text-muted small">Update credentials and account security settings for this member.</p>
        </div>
        <hr />

        <div class="glass-card shadow-lg border-0 overflow-hidden bg-white mx-auto" style="max-width: 900px;">
            @if (User is null)
            {
                <div class="p-5 text-center">
                    <div class="spinner-border text-orange" role="status"></div>
                    <p class="mt-2 text-muted">Fetching user data...</p>
                </div>
            }
            else
            {
                <EditForm Model="User" OnValidSubmit="UpdateUser" FormName="editUser">
                    <DataAnnotationsValidator />
                    <input type="hidden" name="User.UserId" value="@User.UserId" />

                    <div class="p-4 p-md-5">
                        <div class="row g-4">
                            <div class="col-12">
                                <h5 class="fw-bold text-brown mb-3 border-bottom pb-2">
                                    <i class="bi bi-person-badge me-2"></i>Account Credentials
                                </h5>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold small">User Name</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-transparent border-end-0 rounded-start-pill ps-3"><i class="bi bi-at text-muted"></i></span>
                                    <InputText @bind-Value="User.UserName" class="form-control rounded-end-pill px-3 border-start-0" placeholder="username" />
                                </div>
                                <ValidationMessage For="() => User.UserName" class="text-danger small" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold small">Password</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-transparent border-end-0 rounded-start-pill ps-3"><i class="bi bi-key text-muted"></i></span>
                                    <InputText @bind-Value="User.Password" type="text" class="form-control rounded-end-pill px-3 border-start-0" />
                                </div>
                                <ValidationMessage For="() => User.Password" class="text-danger small" />
                            </div>

                            <div class="col-12 mt-4">
                                <h5 class="fw-bold text-brown mb-3 border-bottom pb-2">
                                    <i class="bi bi-shield-lock me-2"></i>System Information
                                </h5>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold small text-muted">Current Role</label>
                                <InputText @bind-Value="User.Role" class="form-control rounded-pill px-3 bg-light" readonly />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold small text-muted">User ID</label>
                                <input type="text" class="form-control rounded-pill px-3 bg-light" value="#@User.UserId" readonly />
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-light border-top text-center">
                        <button type="submit" class="btn btn-warning px-5 py-2 rounded-pill fw-bold shadow-sm me-3 text-white">
                            <i class="bi bi-save2-fill me-2"></i>Save Changes
                        </button>
                        <a href="/users" class="btn btn-outline-secondary px-4 py-2 rounded-pill">Cancel</a>
                    </div>
                </EditForm>
            }
        </div>
    </div>
</div>

<style>
    :root {
        --brown-primary: #5a3e2b;
        --orange-accent: #f0a500;
        --bg-soft: #fdf6ee;
    }

    body {
        background-color: var(--bg-soft);
    }

    .glass-card {
        border-radius: 1.5rem;
    }

    .text-brown {
        color: var(--brown-primary);
    }

    .form-control:focus {
        border-color: var(--orange-accent);
        box-shadow: 0 0 0 0.25rem rgba(240, 165, 0, 0.15);
    }

    .input-group-text {
        border-color: #dee2e6;
    }

    .btn-warning {
        background-color: var(--orange-accent);
        border: none;
        transition: all 0.3s ease;
    }

        .btn-warning:hover {
            background-color: #d69400;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(240, 165, 0, 0.3);
        }
</style>

@code {
    [SupplyParameterFromQuery]
    private int UserId { get; set; }

    [SupplyParameterFromForm]
    private User? User { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        User ??= await context.User.FirstOrDefaultAsync(m => m.UserId == UserId);

        if (User is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
    }

    private async Task UpdateUser()
    {
        using var context = DbFactory.CreateDbContext();
        context.Attach(User!).State = EntityState.Modified;

        try
        {
            await context.SaveChangesAsync();
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!UserExists(User!.UserId))
            {
                NavigationManager.NavigateTo("notfound");
            }
            else
            {
                throw;
            }
        }

        NavigationManager.NavigateTo("/users");
    }

    private bool UserExists(int userid)
    {
        using var context = DbFactory.CreateDbContext();
        return context.User.Any(e => e.UserId == userid);
    }
}