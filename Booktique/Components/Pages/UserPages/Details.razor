@page "/users/details"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Booktique.Models.MainModels
@inject IDbContextFactory<BooktiqueContext> DbFactory
@inject NavigationManager NavigationManager
@attribute [Authorize(Roles = "Administrator")]

<PageTitle>User Account - @(user?.UserName ?? "Details")</PageTitle>

<div class="main-wrapper py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">

                @if (user is null)
                {
                    <div class="text-center py-5">
                        <div class="spinner-border text-brown" role="status"></div>
                        <p class="mt-2">Loading account details...</p>
                    </div>
                }
                else
                {
                    <div class="row mb-5">
                        <div class="col-md-5">
                            <div class="glass-card shadow-sm border-0 h-100 bg-white shadow">
                                <div class="profile-header text-center p-4 bg-light border-bottom">
                                    <div class="profile-avatar mb-3">
                                        <div class="avatar-circle">
                                            <i class="bi bi-person-fill text-white"></i>
                                        </div>
                                    </div>
                                    <h2 class="fw-bold text-brown mb-0">@user.UserName</h2>
                                    <span class="badge rounded-pill @(user.Role == "Administrator" ? "bg-danger" : "bg-brown") mt-2 px-3">
                                        @user.Role
                                    </span>
                                </div>

                                <div class="p-4">
                                    <div class="info-item d-flex align-items-center mb-3 p-3 rounded-3 bg-light">
                                        <div class="info-icon me-3">
                                            <i class="bi bi-person-badge text-orange fs-4"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.7rem;">User ID</small>
                                            <span class="fw-bold text-dark">#@user.UserId</span>
                                        </div>
                                    </div>

                                    <div class="info-item d-flex align-items-center mb-3 p-3 rounded-3 bg-light">
                                        <div class="info-icon me-3">
                                            <i class="bi bi-shield-lock text-orange fs-4"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.7rem;">Security</small>
                                            <span class="text-dark">Encrypted Password</span>
                                        </div>
                                    </div>

                                    <div class="d-grid gap-2 mt-4">
                                        <a href="@($"/users/edit?userid={user.UserId}")" class="btn btn-warning rounded-pill py-2 fw-bold text-decoration-none text-center">
                                            <i class="bi bi-pencil-square me-2"></i>Edit Account
                                        </a>
                                        <a href="/users" class="btn btn-outline-secondary rounded-pill py-2 text-decoration-none text-center">
                                            <i class="bi bi-arrow-left me-2"></i>Back to List
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-7">
                            <div class="h-100 d-flex flex-column gap-3">
                                <div class="p-4 bg-white rounded-4 shadow-sm border flex-grow-1 d-flex align-items-center">
                                    <div class="rounded-circle bg-light p-3 me-4">
                                        <i class="bi bi-bag-check fs-1 text-orange"></i>
                                    </div>
                                    <div>
                                        <h4 class="mb-0 fw-bold">@userOrders.Count</h4>
                                        <p class="text-muted mb-0">Total Placed Orders</p>
                                    </div>
                                </div>
                                <div class="p-4 bg-white rounded-4 shadow-sm border flex-grow-1 d-flex align-items-center">
                                    <div class="rounded-circle bg-light p-3 me-4">
                                        <i class="bi bi-cash-stack fs-1 text-success"></i>
                                    </div>
                                    <div>
                                        <h4 class="mb-0 fw-bold">@userOrders.Sum(o => o.TotalAmount) lei</h4>
                                        <p class="text-muted mb-0">Total Money Spent</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="order-history-section">
                        <h3 class="text-brown fw-bold mb-4">
                            <i class="bi bi-clock-history me-2 text-orange"></i>Orders History
                        </h3>

                        @if (!userOrders.Any())
                        {
                            <div class="p-5 text-center bg-white rounded-4 border shadow-sm">
                                <i class="bi bi-cart-x fs-1 text-muted"></i>
                                <p class="text-muted mt-2">This user doesn't have any orders.</p>
                            </div>
                        }
                        else
                        {
                            <div class="table-responsive bg-white p-3 rounded-4 shadow-sm border">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Date</th>
                                            <th>City</th>
                                            <th>Payment</th>
                                            <th>Total</th>
                                            <th class="text-center">Acțiune</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var order in userOrders)
                                        {
                                            <tr>
                                                <td class="fw-bold">#@order.OrderId</td>
                                                <td>@order.OrderDate.ToString("dd.MM.yyyy")</td>
                                                <td>@order.City</td>
                                                <td><small class="text-muted">@order.PaymentMethod</small></td>
                                                <td class="fw-bold text-brown">@order.TotalAmount lei</td>
                                                <td class="text-center">
                                                    <a href="@($"/orders/details?id={order.OrderId}")" class="btn btn-sm btn-outline-brown rounded-pill px-3 text-decoration-none">
                                                        Details
                                                    </a>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        background-color: #fdf6ee;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    :root {
        --brown-primary: #5a3e2b;
        --orange-accent: #f0a500;
    }

    body {
        background-color: #fdf6ee;
    }

    .glass-card {
        border-radius: 1.5rem;
        overflow: hidden;
    }

    .avatar-circle {
        width: 80px;
        height: 80px;
        background-color: var(--brown-primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        font-size: 2.5rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .text-brown {
        color: var(--brown-primary);
    }

    .text-orange {
        color: var(--orange-accent);
    }

    .bg-brown {
        background-color: var(--brown-primary);
        color: white;
    }

    .btn-brown {
        background-color: var(--brown-primary);
        color: white;
        border: none;
    }

        .btn-brown:hover {
            background-color: #452f21;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

    .btn-outline-brown {
        border-color: var(--brown-primary);
        color: var(--brown-primary);
    }

        .btn-outline-brown:hover {
            background-color: var(--brown-primary);
            color: white;
        }

    .btn-warning {
        color: white;
    }

    .table thead th {
        background-color: #f8f9fa;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        border: none;
        padding: 12px;
    }
</style>

@code {
    private User? user;
    private List<Order> userOrders = new();

    [SupplyParameterFromQuery]
    private int UserId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        // Încarcă user-ul
        user = await context.User
            .FirstOrDefaultAsync(m => m.UserId == UserId);

        if (user is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
        else
        {
            // Preluăm comenzile direct din contextul Order filtrând după UserId
            userOrders = await context.Order
                .Where(o => o.UserId == UserId)
                .OrderByDescending(o => o.OrderDate)
                .ToListAsync();
        }
    }
}