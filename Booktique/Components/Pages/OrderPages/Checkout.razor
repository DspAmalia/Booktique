@page "/checkout"
@using Booktique.Models.MainModels
@using Booktique.Models.Services
@using Microsoft.EntityFrameworkCore
@inject CartService cartService
@inject IDbContextFactory<BooktiqueContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@rendermode InteractiveServer

<div class="container mt-5 mb-5">
    <div class="row">
        @* Coloana Stângă: Detalii Livrare *@
        <div class="col-lg-7">
            <div class="card shadow-sm border-0 p-4 rounded-4 bg-white">
                <h3 class="text-brown fw-bold mb-4"><i class="bi bi-truck me-2"></i>Shipping Details</h3>

                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label fw-bold">Full Name</label>
                        <input @bind="fullName" @bind:event="oninput" type="text" class="form-control" placeholder="E.g. John Doe" />
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Phone Number</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light"><i class="bi bi-telephone"></i></span>
                            <input @bind="phoneNumber" @bind:event="oninput" type="tel" class="form-control" placeholder="07xxxxxxxx" />
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">City</label>
                        <input @bind="city" @bind:event="oninput" type="text" class="form-control" placeholder="Your City" />
                    </div>

                    <div class="col-md-12 mb-4">
                        <label class="form-label fw-bold">Full Delivery Address</label>
                        <textarea @bind="shippingAddress" @bind:event="oninput" class="form-control" rows="3" placeholder="Street, Number, Block, Apartment..."></textarea>
                    </div>
                </div>

                <h3 class="text-brown fw-bold mb-3"><i class="bi bi-credit-card me-2"></i>Payment Method</h3>
                <div class="row g-3">
                    <div class="col-6">
                        <div class="payment-card p-3 border rounded-3 text-center @(paymentMethod == "Cash" ? "selected" : "")"
                             @onclick='() => paymentMethod = "Cash"'>
                            <i class="bi bi-cash-stack fs-2 d-block mb-2 text-success"></i>
                            <span class="fw-bold">Cash on Delivery</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="payment-card p-3 border rounded-3 text-center @(paymentMethod == "Card" ? "selected" : "")"
                             @onclick='() => paymentMethod = "Card"'>
                            <i class="bi bi-credit-card-2-front fs-2 d-block mb-2 text-primary"></i>
                            <span class="fw-bold">Online Card</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* Coloana Dreaptă: Sumar Comandă *@
        <div class="col-lg-5">
            <div class="card shadow-sm border-0 p-4 rounded-4 bg-light sticky-top" style="top: 20px;">
                <h4 class="fw-bold mb-4">Order Summary</h4>

                <div class="cart-items-preview mb-4" style="max-height: 300px; overflow-y: auto;">
                    @foreach (var item in cartService.Items)
                    {
                        <div class="d-flex align-items-center mb-3">
                            <img src="@item.ImagePath" class="rounded me-3 shadow-sm" style="width: 45px; height: 65px; object-fit: cover;" />
                            <div class="flex-grow-1">
                                <h6 class="mb-0 small fw-bold">@item.Title</h6>
                                <span class="text-muted small">@item.Quantity x @item.Price lei</span>
                            </div>
                            <span class="fw-bold small">@(item.Price * item.Quantity) lei</span>
                        </div>
                    }
                    
                    @* Notificare Mystery Book *@
                    @if (!isEligibleForMysteryBook)

                    {

                        decimal remaining = 200 - cartService.Items.Sum(i => i.Price * i.Quantity);

                        <div class="alert alert-info border-0 rounded-4 shadow-sm mb-4">

                            <i class="bi bi-gift-fill me-2"></i>

                            Add <strong>@remaining lei</strong> more to your cart to unlock a <strong>FREE Mystery Book!</strong>

                        </div>

                    }
                    
                    @if (selectedMysteryBook != null)
                    {
                        <div class="d-flex align-items-center mb-3 p-2 rounded-3 border border-success bg-white position-relative shadow-sm animate__animated animate__fadeInUp">
                            <img src="@selectedMysteryBook.BookCoverPath" class="rounded me-3 shadow-sm" style="width: 45px; height: 65px; object-fit: cover;" />
                            <div class="flex-grow-1">
                                <h6 class="mb-0 small fw-bold text-success">@selectedMysteryBook.BookTitle (Gift)</h6>
                                <span class="badge bg-success small">FREE</span>
                            </div>
                            <button class="btn btn-sm text-muted" @onclick="ChangeGiftChoice">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                        </div>
                    }

                <hr />
                <div class="d-flex justify-content-between fs-5 fw-bold text-brown mb-4">
                    <span>Total Payment:</span>
                    <span class="text-orange">@cartService.Items.Sum(i => i.Price * i.Quantity) lei</span>
                </div>

                    @* <div class="text-danger small">
                        DEBUG:
                        Nume: @(!string.IsNullOrWhiteSpace(fullName)) |
                        Tel: @(phoneNumber.Length >= 10) |
                        Plata: @(paymentMethod != null)
                    </div> *@

                <button class="btn btn-warning w-100 fw-bold py-3 shadow rounded-pill btn-finalize"
                        @onclick="FinalizeOrder"
                        disabled="@(!IsFormValid)">
                    <i class="bi bi-lock-fill me-1"></i> @(paymentMethod == "Card" ? "PAY AND FINISH" : "PLACE ORDER")
                </button>

                @if (!IsFormValid)
                {
                    <div class="alert alert-secondary mt-3 py-2 small border-0 text-center">
                        Please fill in all details to finalize.
                    </div>
                }
            </div>
        </div>
    </div>

        @* MODAL PENTRU CADOU *@
        @if (showGiftModal)
        {
            <div class="modal fade show d-block" style="background: rgba(0,0,0,0.6);" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 rounded-4 shadow-lg">
                        <div class="modal-header border-0 bg-success text-white rounded-top-4">
                            <h5 class="modal-title fw-bold"><i class="bi bi-gift me-2"></i>You've unlocked a Mystery Gift!</h5>
                        </div>
                        <div class="modal-body text-center p-5">
                            <p class="mb-4">Since your order is over <strong>200 lei</strong>, please pick one of these mystery boxes:</p>

                            <div class="d-flex justify-content-around py-3">
                                @for (int i = 0; i < 3; i++)
                                {
                                    int index = i;
                                    <div class="gift-box-wrapper text-center" @onclick="() => RevealGift(index)">
                                        <div class="gift-box-icon pulse-animation">🎁</div>
                                        <span class="small text-muted">Box #@(index + 1)</span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
</div>
</div>

<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        background-color: #fdf6ee;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    .text-brown {
        color: #5a3e2b;
    }

    .text-orange {
        color: #f0a500;
    }

    .payment-card {
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid #eee !important;
        background: white;
    }

        .payment-card:hover {
            border-color: #f0a500 !important;
            background-color: #fffdfa;
        }

        .payment-card.selected {
            border-color: #f0a500 !important;
            background-color: #fdf6ee;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

    .btn-finalize:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .rounded-4 {
        border-radius: 1.25rem !important;
    }

    .border-dashed {
        border-style: dashed !important;
    }

    .gift-box-wrapper {
    cursor: pointer;
    transition: transform 0.3s ease;
}

.gift-box-wrapper:hover {
    transform: scale(1.15);
}

.gift-box-icon {
    font-size: 3rem;
    filter: drop-shadow(0 5px 10px rgba(40, 167, 69, 0.2));
}

.pulse-animation {
    animation: boxPulse 1.5s infinite ease-in-out;
}

@@keyframes boxPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.revealed-gift-anim {
    animation: fadeIn zoomIn 0.5s ease-out;
}

.revealed-img {
    width: 60px;
    height: 90px;
    object-fit: cover;
    border-radius: 5px;
    border: 2px solid #28a745;
}

.mystery-selection-container {
    border: 2px dashed #28a745;
    background: #f9fffb;
}
.animate__animated {
    animation-duration: 0.5s;
    animation-fill-mode: both;
}

@@keyframes fadeInUp {
    from { opacity: 0; transform: translate3d(0, 40px, 0); }
    to { opacity: 1; transform: translate3d(0, 0, 0); }
}

.animate__fadeInUp { animation-name: fadeInUp; }

@@keyframes zoomIn {
    from { opacity: 0; transform: scale(0.5); }
    to { opacity: 1; transform: scale(1); }
}
</style>


@code {
    private string fullName = "";
    private string phoneNumber = "";
    private string city = "";
    private string shippingAddress = "";
    private string? paymentMethod = null;
    
    private bool isEligibleForMysteryBook = false;
    private Book? selectedMysteryBook = null;
    private List<Book> potentialGifts = new();
    private bool showGiftModal = false;

    private bool IsFormValid =>
        !string.IsNullOrWhiteSpace(fullName) &&
        !string.IsNullOrWhiteSpace(phoneNumber) &&
        !string.IsNullOrWhiteSpace(city) &&
        !string.IsNullOrWhiteSpace(shippingAddress) &&
        !string.IsNullOrEmpty(paymentMethod) &&
        phoneNumber.Length >= 10 &&
        (!isEligibleForMysteryBook || selectedMysteryBook != null); 

    protected override async Task OnInitializedAsync()
    {
        await CheckMysteryEligibility();
    }

    private async Task CheckMysteryEligibility()
    {
        decimal cartTotal = cartService.Items.Sum(i => i.Price * i.Quantity);

        if (cartTotal >= 200)
        {
            isEligibleForMysteryBook = true;

            if (selectedMysteryBook == null)
            {
                await PrepareGifts();
                showGiftModal = true;
            }
        }
        else
        {
            isEligibleForMysteryBook = false;
            selectedMysteryBook = null;
            showGiftModal = false;
        }
    }

    private void RevealGift(int index)
    {
        if (potentialGifts.Count > index)
        {
            selectedMysteryBook = potentialGifts[index];
            showGiftModal = false; 
            StateHasChanged();
        }
    }

    private void ChangeGiftChoice()
    {
        selectedMysteryBook = null;
        showGiftModal = true; 
    }

    private async Task PrepareGifts()
    {
        using var ctx = await DbFactory.CreateDbContextAsync();
        potentialGifts = await ctx.Book
            .Where(b => b.BookStock > 0)
            .OrderBy(r => Guid.NewGuid())
            .Take(3)
            .ToListAsync();
    }

    private void ResetGift() => selectedMysteryBook = null;

    private async Task FinalizeOrder()
    {
        if (!IsFormValid) return;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userIdString = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value
                           ?? user.FindFirst("UserId")?.Value;

        if (string.IsNullOrEmpty(userIdString) || !int.TryParse(userIdString, out int userIdInt))
        {
            return;
        }

        try
        {
            using var ctx = await DbFactory.CreateDbContextAsync();
            using var transaction = await ctx.Database.BeginTransactionAsync();

            try
            {
                var groupedItems = cartService.Items.GroupBy(i => i.SellerId).ToList();

                foreach (var group in groupedItems)
                {
                    var order = new Order
                        {
                            UserId = userIdInt,
                            SellerId = group.Key, 
                            OrderDate = DateTime.Now,
                            TotalAmount = group.Sum(i => i.Price * i.Quantity),
                            ShippingAddress = $"{fullName} - {shippingAddress}",
                            City = city,
                            PhoneNumber = phoneNumber,
                            PaymentMethod = paymentMethod!,
                            Status = OrderStatus.Pending,
                            LastUpdated = DateTime.Now,
                            OrderItems = new List<OrderItem>()
                        };

                    foreach (var item in group)
                    {
                        var dbBook = await ctx.Book.FirstOrDefaultAsync(b => b.BookId == item.BookId);

                        if (dbBook != null)
                        {
                            if (dbBook.BookStock >= item.Quantity)
                            {
                                dbBook.BookStock -= item.Quantity;

                                order.OrderItems.Add(new OrderItem
                                    {
                                        BookId = dbBook.BookId,
                                        Quantity = item.Quantity,
                                        UnitPrice = item.Price,
                                    });
                            }
                            else
                            {
                                throw new Exception($"Stock insufficient for: {dbBook.BookTitle}");
                            }
                        }
                    }

                    // Mystery Book DOAR la comanda "Official" (unde SellerId e null sau 0)
                    if ((group.Key == null || group.Key == 0) && isEligibleForMysteryBook && selectedMysteryBook != null)
                    {
                        var giftInDb = await ctx.Book.FirstOrDefaultAsync(b => b.BookId == selectedMysteryBook.BookId);
                        if (giftInDb != null && giftInDb.BookStock > 0)
                        {
                            giftInDb.BookStock -= 1;
                            order.OrderItems.Add(new OrderItem
                                {
                                    BookId = giftInDb.BookId,
                                    Quantity = 1,
                                    UnitPrice = 0
                                });
                        }
                    }

                    ctx.Order.Add(order);
                }

                await ctx.SaveChangesAsync();
                await transaction.CommitAsync();

                await cartService.ClearCart();
                Nav.NavigateTo("/order-success");
            }
            catch (Exception ex)
            {
                await transaction.RollbackAsync();
                Console.WriteLine($"Transaction Error: {ex.Message}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"General Error: {ex.Message}");
        }
    }
}