@page "/antique/delete"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Booktique.Models.MainModels
@inject IDbContextFactory<BooktiqueContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Delete Listing | Antique Booktique</PageTitle>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card shadow-sm border-0">
                <div class="card-body p-4 text-center">
                    <i class="bi bi-exclamation-octagon text-danger display-1 mb-3"></i>
                    <h2 class="fw-bold mb-3">Delete Confirmation</h2>

                    @if (book is null)
                    {
                        <div class="py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="text-muted mt-2">Verifying record integrity...</p>
                        </div>
                    }
                    else if (book.Seller is null)
                    {
                        @* CAZUL ÎN CARE SELLER-UL LIPSEȘTE *@
                        <div class="alert alert-warning border-0 shadow-sm">
                            <h5 class="fw-bold"><i class="bi bi-shield-lock-fill me-2"></i>Action Restricted</h5>
                            <p class="mb-0">This listing is currently locked because the <strong>Seller information is missing or null</strong>. Only valid merchant records can be processed for deletion.</p>
                        </div>
                        <a href="/antiquelistings" class="btn btn-secondary w-100 rounded-pill mt-3">Back to Listings</a>
                    }
                    else
                    {
                        @* CAZUL ÎN CARE SELLER-UL EXISTĂ *@
                        <p class="text-muted">Are you sure you want to remove the book <strong>"@book.BookTitle"</strong> posted by <strong>@book.Seller.UserName</strong>?</p>

                        <div class="bg-light p-3 rounded-3 mb-4 text-start">
                            <div class="small text-muted text-uppercase fw-bold">Seller Verification</div>
                            <div class="d-flex align-items-center mt-2">
                                <div class="bg-success rounded-circle p-1 me-2" style="width: 10px; height: 10px;"></div>
                                <span class="fw-bold">@book.Seller.UserEmail</span>
                            </div>
                        </div>

                        <EditForm Model="book" OnValidSubmit="DeleteAntiqueListing" FormName="delete">
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-danger btn-lg rounded-pill shadow-sm">
                                    <i class="bi bi-trash3 me-2"></i>Delete Permanently
                                </button>
                                <a href="/antiquelistings" class="btn btn-outline-secondary btn-lg rounded-pill border-0">Cancel and Keep</a>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=IM+Fell+English:ital@0;1&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap');

    body {
        background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png'), linear-gradient(to bottom, #2c1e14, #3d2b1f);
        background-attachment: fixed;
    }

    .inventory-scroll {
        background-color: #f2e8d5;
        background-image: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(0,0,0,0.05) 100%), url('https://www.transparenttextures.com/patterns/old-map.png');
        border: 2px solid #a73a3a;
        box-shadow: 0 30px 60px rgba(0,0,0,0.8);
        border-radius: 4px;
    }

    .archive-label {
        font-family: 'Cinzel', serif;
        letter-spacing: 3px;
        font-weight: 700;
        font-size: 0.9rem;
    }

    .archive-title {
        font-family: 'IM Fell English', serif;
        font-size: 2.5rem;
        font-weight: bold;
        color: #1a120b;
    }

    .archive-author {
        font-family: 'Playfair Display', serif;
        font-style: italic;
    }

    .record-preview {
        background: rgba(0, 0, 0, 0.03);
        border: 1px dashed #8b6b3e;
    }

    .registry-section-title {
        font-family: 'Cinzel', serif;
        color: #1a120b;
        border-bottom: 1px solid #8b6b3e;
        display: inline-block;
    }

    .alert-danger-antique {
        background-color: rgba(167, 58, 58, 0.1);
        border: 1px solid #a73a3a;
        color: #7a0000;
        display: flex;
        align-items: center;
        padding: 20px;
        font-family: 'Playfair Display', serif;
    }

    /* Butoane */
    .btn-expunge {
        background: #4a0000;
        color: #f2e8d5;
        border: none;
        font-family: 'Cinzel', serif;
        box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        transition: 0.3s;
    }

        .btn-expunge:hover {
            background: #7a0000;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.2);
        }

    .btn-scroll-edit {
        border: 1px solid #2c1e14;
        color: #2c1e14;
        font-family: 'Cinzel', serif;
    }

    .btn-quill {
        color: #d4c5a9;
        font-family: 'Cinzel', serif;
    }

    .text-brown-dark {
        color: #3d2b1f;
    }
</style>


@code {
    private Book? book;

    [SupplyParameterFromQuery]
    private int Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        // FOARTE IMPORTANT: Folosim .Include(b => b.Seller) pentru a încărca datele vânzătorului
        book = await context.Book
            .Include(b => b.Seller)
            .FirstOrDefaultAsync(m => m.BookId == Id);

        if (book is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
    }

    private async Task DeleteAntiqueListing()
    {
        if (book?.Seller != null)
        {
            using var context = DbFactory.CreateDbContext();

            var dbBook = await context.Book.FindAsync(book.BookId);

            if (dbBook != null)
            {
                context.Book.Remove(dbBook);
                await context.SaveChangesAsync();
                NavigationManager.NavigateTo("/antiquelistings");
            }
        }
    }
}