@page "/favorites"
@using Booktique.Models.MainModels
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<BooktiqueContext> DbFactory
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<div class="container-fluid pb-5">
    <div class="d-flex align-items-center justify-content-between mt-4 mb-4">
        <h2 class="mb-0">My <strong>Favorite Books</strong></h2>
        <div class="d-flex gap-3">
            <button class="btn btn-outline-dark rounded-pill shadow-sm" @onclick="ShowFolderModal">
                <i class="bi bi-folder-plus me-2"></i>New Folder
            </button>
        </div>
    </div>

    @if (!isAuthenticated)
    {
        <div class="text-center p-5"><div class="spinner-border text-warning"></div><p>Redirecting...</p></div>
    }
    else if (favoriteBooks is null)
    {
        <div class="text-center p-5"><div class="spinner-border text-warning"></div><p>Loading your collection...</p></div>
    }
    else
    {
        <div class="favorites-layout">
            <aside class="folder-sidebar">
                <h5 class="fw-bold mb-3 px-2 text-uppercase small letter-spacing-1">Your Library</h5>

                <div class="folder-nav-item @(activeFolderId == null ? "active" : "")" @onclick="() => SelectFolder(null)">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <span><i class="bi bi-grid-fill me-2"></i>Unorganized</span>
                        <span class="badge rounded-pill bg-light text-dark border">@favoriteBooks.Count</span>
                    </div>
                </div>

                @if (userFolders.Any())
                {
                    <hr class="my-3 opacity-10">
                    @foreach (var folder in userFolders)
                    {
                        <div class="folder-nav-item @(activeFolderId == folder.FolderId ? "active" : "")"
                             @onclick="() => SelectFolder(folder.FolderId)">
                            <div class="d-flex justify-content-between align-items-center w-100">
                                <span class="text-truncate me-2">
                                    <i class="bi @(activeFolderId == folder.FolderId ? "bi-folder2-open" : "bi-folder2") me-2"></i>
                                    @folder.FolderName
                                </span>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge rounded-pill bg-light text-dark border">
                                        @(folderContents.ContainsKey(folder.FolderId) ? folderContents[folder.FolderId].Count : "0")
                                    </span>
                                    <i class="bi bi-pencil-square text-muted edit-icon" @onclick:stopPropagation="true" @onclick="() => ShowEditFolderModal(folder)"></i>
                                    <i class="bi bi-trash text-danger edit-icon" @onclick:stopPropagation="true" @onclick="() => DeleteFolder(folder.FolderId)"></i>
                                </div>
                            </div>
                        </div>
                    }
                }
            </aside>

            <main class="content-area">
                <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                    <h4 class="mb-0 fw-bold text-dark">
                        @(activeFolderId == null ? "Unorganized Books" : userFolders.FirstOrDefault(f => f.FolderId == activeFolderId)?.FolderName)
                    </h4>
                    @if (activeFolderId != null)
                    {
                        <button class="btn btn-sm btn-warning rounded-pill px-3 shadow-sm" @onclick="() => ShowAddBookPanelForFolder(activeFolderId.Value)">
                            <i class="bi bi-plus-lg me-1"></i> Add Book Here
                        </button>
                    }
                </div>

                @if (!GetCurrentBooks().Any())
                {
                    <div class="text-center p-5 bg-white rounded-4 shadow-sm border border-dashed">
                        <i class="bi bi-book text-muted opacity-50" style="font-size: 3.5rem;"></i>
                        <p class="mt-3 text-muted">This section is currently empty.</p>
                        <a href="/" class="btn btn-sm btn-outline-secondary rounded-pill">Explore Books</a>
                    </div>
                }
                else
                {
                    <div class="books-grid animate__animated animate__fadeIn">
                        @foreach (var book in GetCurrentBooks())
                        {
                            <div class="book-card-wrapper position-relative">
                                @if (book.BookStock == 0)
                                {
                                    <div class="sold-out-badge">
                                        <span class="badge bg-danger shadow">SOLD OUT</span>
                                    </div>
                                }
                                <div class="book-card shadow-sm @(book.BookStock == 0 ? "is-sold-out" : "")">
                                    <div class="book-img-container">
                                        <a href="@($"/books/details?bookid={book.BookId}")" class="d-block w-100 h-100 text-center p-3">
                                            <img src="@book.BookCoverPath" alt="@book.BookTitle" class="book-img" />
                                        </a>

                                        @* Butonul de Favorite (Remove) *@
                                        <button type="button" class="wishlist-btn" title="Remove"
                                                @onclick="() => HandleBookAction(book.BookId)">
                                            <i class="bi bi-heart-fill text-danger"></i>
                                        </button>
                                    </div>

                                    <a class="text-decoration-none text-dark" href="@($"/books/details?bookid={book.BookId}")">
                                        <div class="book-info p-3 d-flex flex-column align-items-center">
                                            <h6 class="book-title text-truncate text-center w-100 mb-1">
                                                <strong>@book.BookTitle</strong>
                                            </h6>
                                            <p class="book-author text-muted small mb-2 text-center w-100">@book.BookAuthor</p>
                                            <div class="mt-1">
                                                <span class="book-price fw-bold text-accent-yellow">@book.BookPrice LEI</span>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        }
                    </div>
                }
            </main>
        </div>
    }
</div>

@* MODAL: ADD FOLDER *@
@if (showModal)
{
    <div class="modal-backdrop d-flex justify-content-center align-items-center" style="background: rgba(0,0,0,0.5); position:fixed; top:0; left:0; width:100%; height:100%; z-index:1050;">
        <div class="bg-white p-4 rounded-4 shadow-lg" style="width: 400px;">
            <h5 class="fw-bold mb-3">Create New Folder</h5>
            <input type="text" class="form-control mb-3" placeholder="Folder Name" @bind="newFolder.FolderName" />
            <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-light" @onclick="HideFolderModal">Cancel</button>
                <button class="btn btn-dark" @onclick="AddFolder">Create</button>
            </div>
        </div>
    </div>
}

@* MODAL: EDIT FOLDER *@
@if (showEditModal && folderToEdit != null)
{
    <div class="modal-backdrop d-flex justify-content-center align-items-center" style="background: rgba(0,0,0,0.5); position:fixed; top:0; left:0; width:100%; height:100%; z-index:1050;">
        <div class="bg-white p-4 rounded-4 shadow-lg" style="width: 400px;">
            <h5 class="fw-bold mb-3">Rename Folder</h5>
            <input type="text" class="form-control mb-3" @bind="folderToEdit.FolderName" />
            <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-light" @onclick="HideEditFolderModal">Cancel</button>
                <button class="btn btn-dark" @onclick="UpdateFolderName">Save Changes</button>
            </div>
        </div>
    </div>
}

@* PANEL: MOVE BOOK TO FOLDER *@
@if (showAddBookPanel && activeFolderId.HasValue)
{
    <div class="modal-backdrop d-flex justify-content-center align-items-center" style="background: rgba(0,0,0,0.5); position:fixed; top:0; left:0; width:100%; height:100%; z-index:1050;">
        <div class="bg-white p-4 rounded-4 shadow-lg animate__animated animate__zoomIn" style="width: 500px; max-height: 80vh; overflow-y: auto;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 fw-bold">Move to Folder</h5>
                <button class="btn-close" @onclick="() => showAddBookPanel = false"></button>
            </div>
            <p class="small text-muted mb-3">Select a book from your unorganized list:</p>
            @foreach (var book in favoriteBooks ?? new())
            {
                <div class="d-flex align-items-center justify-content-between border-bottom py-2 folder-selection-row">
                    <div class="d-flex align-items-center">
                        <img src="@book.BookCoverPath" style="width: 35px; height: 50px; object-fit: cover;" class="rounded me-2 shadow-sm" />
                        <span class="small fw-bold text-truncate" style="max-width: 250px;">@book.BookTitle</span>
                    </div>
                    <button class="btn btn-sm btn-warning rounded-pill px-3" @onclick="() => AddBookToFolder(book.BookId)">Move</button>
                </div>
            }
            @if (!favoriteBooks?.Any() ?? true)
            {
                <p class="text-center py-3 text-muted">No unorganized books available.</p>
            }
        </div>
    </div>
}

<style>

    body {
        background-color: #fdf6ee;
    }

    .favorites-layout {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 2.5rem;
    }

    .folder-sidebar {
        background: #ffffff;
        padding: 1.5rem;
        border-radius: 20px;
        border: 1px solid #f0f0f0;
        height: fit-content;
        box-shadow: 0 4px 15px rgba(0,0,0,0.02);
        position: sticky;
        top: 20px;
    }

    .folder-nav-item {
        padding: 12px 16px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-bottom: 0.4rem;
        display: flex;
        align-items: center;
        color: #636e72;
        border: 1px solid transparent;
    }

        .folder-nav-item:hover {
            background: #fff9f4;
            border-color: #ceb9a6;
            color: #2d3436;
        }

        .folder-nav-item.active {
            background: #ceb9a6;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(206, 185, 166, 0.3);
        }

            .folder-nav-item.active .badge {
                background: rgba(255,255,255,0.2) !important;
                color: white !important;
                border: none !important;
            }

    .edit-icon {
        cursor: pointer;
        transition: 0.2s;
    }

        .edit-icon:hover {
            color: #ceb9a6 !important;
            transform: scale(1.1);
        }

    .book-card {
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.4s ease;
        height: 100%;
        position: relative;
        border: 1px solid transparent;
    }

    .books-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 1.5rem;
        padding-bottom: 50px;
    }

    .book-card-wrapper {
        transition: transform 0.3s ease;
    }

        .book-card-wrapper:hover {
            transform: translateY(-10px);
        }

    .book-img-container {
        position: relative;
        height: 300px;
        background: #fff;
    }

    .book-img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        display: block;
        margin: auto;
    }

    .wishlist-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        border: none;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        z-index: 11;
    }

    .is-sold-out {
        filter: grayscale(1);
        opacity: 0.6;
    }

    .sold-out-badge {
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 20;
    }

    .text-accent-yellow {
        color: #f0a500;
        font-size: 1.2rem;
        font-weight: 800;
    }
</style>

@code {
    private List<Book>? favoriteBooks;
    private List<Folder> userFolders = new();
    private Dictionary<int, List<Book>> folderContents = new();
    private int? activeFolderId = null;

    private bool isAuthenticated = false;
    private bool showModal = false;
    private bool showEditModal = false;
    private bool showAddBookPanel = false;
    private Folder newFolder = new();
    private Folder? folderToEdit;
    private int? folderToAddTo = null;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        isAuthenticated = authState.User.Identity?.IsAuthenticated == true;

        if (!isAuthenticated)
        {
            NavigationManager.NavigateTo("/access-denied", forceLoad: true);
            return;
        }

        await LoadData();
    }

    private async Task LoadData()
    {
        using var context = DbFactory.CreateDbContext();
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var userName = authState.User.Identity?.Name;

        var user = await context.User.FirstOrDefaultAsync(u => u.UserName == userName);
        if (user is null) return;

        favoriteBooks = await context.Favorite
            .Where(f => f.UserId == user.UserId && f.FolderId == null)
            .Include(f => f.Book)
            .Select(f => f.Book!)
            .ToListAsync();

        userFolders = await context.Folder
            .Where(f => f.UserId == user.UserId)
            .ToListAsync();

        folderContents.Clear();
        foreach (var folder in userFolders)
        {
            var books = await context.Favorite
                .Where(f => f.FolderId == folder.FolderId)
                .Include(f => f.Book)
                .Select(f => f.Book!)
                .ToListAsync();
            folderContents[folder.FolderId] = books;
        }
    }

    private IEnumerable<Book> GetCurrentBooks()
    {
        if (activeFolderId == null) return favoriteBooks ?? new();
        return folderContents.TryGetValue(activeFolderId.Value, out var books) ? books : new List<Book>();
    }

    private void SelectFolder(int? folderId) => activeFolderId = folderId;

    private async Task HandleBookAction(int bookId)
    {
        using var context = DbFactory.CreateDbContext();
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var userName = authState.User.Identity?.Name;
        var user = await context.User.FirstOrDefaultAsync(u => u.UserName == userName);

        if (activeFolderId == null)
        {
            var fav = await context.Favorite.FirstOrDefaultAsync(f => f.BookId == bookId && f.UserId == user!.UserId && f.FolderId == null);
            if (fav != null) context.Favorite.Remove(fav);
        }
        else
        {
            var fav = await context.Favorite.FirstOrDefaultAsync(f => f.BookId == bookId && f.FolderId == activeFolderId);
            if (fav != null) fav.FolderId = null;
        }

        await context.SaveChangesAsync();
        await LoadData();
    }

    private void ShowAddBookPanelForFolder(int folderId)
    {
        folderToAddTo = folderId;
        showAddBookPanel = true;
    }

    private async Task AddBookToFolder(int bookId)
    {
        if (folderToAddTo == null) return;
        using var context = DbFactory.CreateDbContext();
        var favorite = await context.Favorite.FirstOrDefaultAsync(f => f.BookId == bookId && f.FolderId == null);
        if (favorite != null)
        {
            favorite.FolderId = folderToAddTo;
            await context.SaveChangesAsync();
            await LoadData();
        }
        showAddBookPanel = false;
    }

    private void ShowFolderModal() => showModal = true;
    private void HideFolderModal() { showModal = false; newFolder = new(); }

    private async Task AddFolder()
    {
        if (string.IsNullOrWhiteSpace(newFolder.FolderName)) return;
        using var context = DbFactory.CreateDbContext();
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = await context.User.FirstOrDefaultAsync(u => u.UserName == authState.User.Identity.Name);
        if (user != null)
        {
            newFolder.UserId = user.UserId;
            context.Folder.Add(newFolder);
            await context.SaveChangesAsync();
            await LoadData();
            HideFolderModal();
        }
    }

    private void ShowEditFolderModal(Folder folder)
    {
        folderToEdit = new Folder { FolderId = folder.FolderId, FolderName = folder.FolderName, UserId = folder.UserId };
        showEditModal = true;
    }

    private void HideEditFolderModal() { showEditModal = false; folderToEdit = null; }

    private async Task UpdateFolderName()
    {
        if (folderToEdit == null) return;
        using var context = DbFactory.CreateDbContext();
        var folder = await context.Folder.FindAsync(folderToEdit.FolderId);
        if (folder != null)
        {
            folder.FolderName = folderToEdit.FolderName;
            await context.SaveChangesAsync();
            await LoadData();
            HideEditFolderModal();
        }
    }

    private async Task DeleteFolder(int folderId)
    {
        using var context = DbFactory.CreateDbContext();

        var folder = await context.Folder.FindAsync(folderId);
        if (folder != null)
        {
            var linkedFavorites = await context.Favorite
                .Where(f => f.FolderId == folderId)
                .ToListAsync();

            foreach (var fav in linkedFavorites)
            {
                fav.FolderId = null;
            }

            context.Folder.Remove(folder);

            await context.SaveChangesAsync();

            if (activeFolderId == folderId)
            {
                activeFolderId = null;
            }

            await LoadData();
        }
    }
}