@page "/books/details"

@using Microsoft.EntityFrameworkCore
@using Booktique.Models.MainModels
@using Booktique.Models.Services

@inject IDbContextFactory<BooktiqueContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject CartService cartService

@rendermode InteractiveServer
@implements IDisposable

<PageTitle>@pageTitle</PageTitle>

<div class="main-wrapper py-4">
    <div class="container">
        @if (book is null)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-brown" role="status"></div>
                <p class="mt-2">Loading book details...</p>
            </div>
        }
        else
        {
            <div class="glass-card mb-5 shadow-sm">
                <div class="row g-0">
                    <div class="col-md-3 p-4 text-center border-end bg-light-subtle">
                        <div class="book-cover-container mb-3">
                            <img src="@book.BookCoverPath" alt="@book.BookTitle" class="img-fluid rounded shadow-sm" style="max-height: 280px;" />
                        </div>
                        <div class="rating-display">
                            <div class="stars mb-1 fs-4 text-warning">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    <span>@(i <= book.BookRating ? "★" : "☆")</span>
                                }
                            </div>
                            <span class="small text-muted fw-bold">@reviews.Count Reviews</span>
                        </div>
                    </div>

                    <div class="col-md-9 p-4 d-flex flex-column justify-content-between">
                        <div>
                            <div class="d-flex justify-content-between align-items-start">
                                <h2 class="fw-bold text-brown mb-0">@book.BookTitle</h2>
                                <h3 class="text-orange fw-bold">@book.BookPrice lei</h3>
                            </div>
                            <p class="text-muted mb-4">by <span class="fw-bold">@book.BookAuthor</span></p>

                            <div class="specs-grid mb-4">
                                <div class="spec-item"><i class="bi bi-tag-fill me-2"></i><strong>Category:</strong> @book.BookCategory</div>
                                <div class="spec-item"><i class="bi bi-calendar-event me-2"></i><strong>Year:</strong> @book.BookYear</div>
                                <div class="spec-item"><i class="bi bi-file-earmark-text me-2"></i><strong>Pages:</strong> @book.BookNumberPag</div>

                                <div class="spec-item"><i class="bi bi-translate me-2"></i><strong>Language:</strong> @book.BookLanguage</div>
                                <div class="spec-item"><i class="bi bi-building me-2"></i><strong>Publisher:</strong> @book.BookPublishingHouse</div>
                                <div class="spec-item"><i class="bi bi-box-seam me-2"></i><strong>Stock:</strong> @book.BookStock</div>
                            </div>
                        </div>

                        <div class="action-buttons d-flex gap-3 align-items-center bg-light p-3 rounded-4">
                            <a class="btn btn-outline-secondary rounded-pill px-4" href="/">Back to List</a>

                            <AuthorizeView>
                                <Authorized>
                                    <button class="btn btn-brown flex-grow-1 rounded-pill fw-bold py-2" @onclick="HandleAddToCart">
                                        <i class="bi @(isAdded ? "bi-cart-check-fill text-warning" : "bi-cart-plus") me-2"></i>
                                        @(isAdded ? "In Cart" : "Add to Cart")
                                    </button>
                                    <button class="btn btn-favorite-circle" @onclick="ToggleFavorite">
                                        <span style="color: @(isFavorite ? "#e74c3c" : "#aaa")">@(isFavorite ? "❤️" : "🤍")</span>
                                    </button>
                                </Authorized>
                            </AuthorizeView>

                            <AuthorizeView Roles="Administrator">
                                <div class="admin-actions d-flex gap-2">
                                    <a class="btn btn-warning btn-sm rounded-pill" href="@($"/books/edit?bookid={BookId}")">Edit</a>
                                    <a class="btn btn-danger btn-sm rounded-pill" href="@($"/books/delete?bookid={BookId}")">Delete</a>
                                </div>
                            </AuthorizeView>
                        </div>
                    </div>
                </div>
            </div>

            <div class="description-card p-4 mb-5 shadow-sm rounded-4 bg-white border">
                <h4 class="text-brown fw-bold border-bottom pb-2 mb-3">
                    <i class="bi bi-justify-left me-2 text-orange"></i>Description
                </h4>
                <p class="book-description mb-0">@book.BookDescription</p>
            </div>

            <div class="book-description-container">
                <h3 class="text-brown fw-bold mb-4">User Reviews</h3>
                @if (reviews is null)
                {
                    <p><em>Loading reviews...</em></p>
                }
                else if (!reviews.Any())
                {
                    <p class="text-muted italic">No reviews yet for this book.</p>
                }
                else
                {
                    <div class="row row-cols-1 row-cols-md-2 g-3 mb-4">
                        @foreach (var r in reviews)
                        {
                            <div class="col">
                                <div class="review-card-simple p-3 shadow-sm rounded-4 bg-white border h-100 position-relative">

                                    <AuthorizeView Roles="Administrator">
                                        <button class="btn btn-sm btn-outline-danger position-absolute bottom-0 end-0 m-2 rounded-circle"
                                                style="width: 35px; height: 35px; padding: 0; z-index: 10;"
                                                @onclick="() => HandleDeleteReview(r.ReviewId)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </AuthorizeView>

                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong class="text-brown">@(r.User?.UserName ?? r.GuestName ?? "Guest")</strong>
                                        <span class="text-muted small">@r.CreatedAt.ToShortDateString()</span>
                                    </div>
                                    <div class="text-warning mb-2">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            @(i <= r.Rating ? "★" : "☆")
                                        }
                                    </div>
                                    <p class="mb-0 text-muted small" style="white-space: pre-line;">@r.Comment</p>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="add-review-card bg-white p-4 rounded-4 shadow-sm border mb-5">
                <h4 class="text-brown fw-bold mb-3">Leave a Review</h4>
                <EditForm Model="@newReview" OnValidSubmit="HandleValidSubmit" FormName="AddReviewForm">
                    <div class="mb-3">
                        <label class="form-label d-block small fw-bold text-muted text-uppercase">Rating</label>
                        <div class="star-rating-input">
                            @for (int i = 1; i <= 5; i++)
                            {
                                var ratingValue = i;
                                <span class="star-clickable @(newReview.Rating >= ratingValue ? "selected" : "")"
                                      @onclick="() => newReview.Rating = ratingValue">★</span>
                            }
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted text-uppercase">Your Comment</label>
                        <InputTextArea @bind-Value="newReview.Comment" class="form-control rounded-3 border-light-subtle bg-light" rows="3" placeholder="What did you think about the book?" />
                    </div>
                    <button type="submit" class="btn btn-brown rounded-pill px-5 fw-bold">Post Review</button>
                </EditForm>
            </div>

            @if (relatedBooks?.Any() == true)
            {
                <section class="for-you-wrapper">
                    <div class="for-you-inner">
                        <h3 class="mb-4 text-dark"><strong>For You — More in <span class="fw-bold">@book.BookCategory</span></strong></h3>
                        <div class="books-grid">
                            @foreach (var b in relatedBooks)
                            {
                                <div class="book-card-wrapper" @onclick="() => NavigateToDetails(b.BookId)">
                                    <div class="book-card">
                                        <img src="@b.BookCoverPath" alt="@b.BookTitle" class="book-img" />
                                        <div class="book-info">
                                            <h5 class="book-title text-truncate w-100">@b.BookTitle</h5>
                                            <p class="book-author-year">
                                                <strong>Author:</strong> @b.BookAuthor <br />
                                                <strong>Year:</strong> @b.BookYear
                                            </p>
                                            <p class="book-price"><strong>@b.BookPrice lei</strong></p>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </section>
            }
        }
    </div>
</div>

<style>
    :root {
        --brown-primary: #5a3e2b;
        --orange-accent: #f0a500;
    }

    body {
        background-color: #fdf6ee;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .glass-card {
        background: white;
        border-radius: 1.5rem;
        overflow: hidden;
        border: 1px solid rgba(0,0,0,0.05);
    }

    .text-brown {
        color: var(--brown-primary);
    }

    .text-orange {
        color: var(--orange-accent);
    }

    .btn-brown {
        background: var(--brown-primary);
        color: white;
        border: none;
    }

        .btn-brown:hover {
            background: #452f21;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(90, 62, 43, 0.3);
        }

    .specs-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); 
    gap: 1.2rem; 
    font-size: 0.95rem;
    }

    @@media (max-width: 768px) {
        .specs-grid {
            grid-template-columns: 1fr 1fr; /* 2 coloane pe tabletă */
        }
    }
    @@media (max-width: 480px) {
        .specs-grid {
            grid-template-columns: 1fr;  /* 1 coloană pe telefon */
        }
    }

    .spec-item i {
        color: var(--orange-accent);
        font-size: 1.1rem;
    }

    .description-card {
        border-left: 5px solid var(--orange-accent) !important;
    }

    .book-description {
        color: #444;
        line-height: 1.8;
        font-size: 1.05rem;
        white-space: pre-line;
    }

    .btn-favorite-circle {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 1px solid #eee;
        background: white;
        transition: 0.3s;
    }

        .btn-favorite-circle:hover {
            background: #fff5f5;
            transform: scale(1.1);
            border-color: #ffcdd2;
        }

    .star-rating-input {
        font-size: 2.2rem;
        color: #e0e0e0;
        margin-top: -10px;
    }

    .star-clickable {
        cursor: pointer;
        transition: 0.2s;
    }

        .star-clickable:hover, .star-clickable.selected {
            color: var(--orange-accent);
        }

    .for-you-wrapper {
        width: 100vw;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        background-color: #ceb9a6;
        padding: 4rem 0;
    }

    .for-you-inner {
        max-width: 1300px;
        margin: 0 auto;
        padding: 0 2rem;
    }

    .books-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 2rem;
    }

    .book-card {
        background: white;
        border-radius: 15px;
        padding: 1.2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        height: 100%;
        border: none;
    }

        .book-card:hover {
            transform: translateY(-12px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }

    .book-img {
        width: 100%;
        height: 280px;
        object-fit: cover;
        border-radius: 10px;
        margin-bottom: 1rem;
    }

    .book-price {
        color: #f0a500;
    }
</style>

@code {
    private Book? book;
    private string pageTitle = "Book Details";
    private List<Review> reviews = new();

    [SupplyParameterFromForm]
    private Review newReview { get; set; } = new() { Rating = 0 }; 

    [SupplyParameterFromQuery]
    public int BookId { get; set; }

    private bool isFavorite = false;
    private List<Book> relatedBooks = new();
    private bool isAdded = false;

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        book = await context.Book
            .Include(b => b.Reviews)
            .ThenInclude(r => r.User)
            .FirstOrDefaultAsync(b => b.BookId == BookId);

        if (book != null)
        {
            pageTitle = book.BookTitle;
            reviews = book.Reviews.OrderByDescending(r => r.CreatedAt).ToList();

            // Verificăm dacă e favorit
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userName = authState.User.Identity?.Name;
            if (!string.IsNullOrEmpty(userName))
            {
                var user = await context.User.FirstOrDefaultAsync(u => u.UserName == userName);
                if (user != null)
                {
                    isFavorite = await context.Favorite.AnyAsync(f => f.UserId == user.UserId && f.BookId == BookId);
                }
            }

            // Cărți sugerate
            relatedBooks = await context.Book
                .Where(b => b.BookCategory == book.BookCategory && b.BookId != book.BookId)
                .OrderBy(_ => Guid.NewGuid())
                .Take(4)
                .ToListAsync();
        }
        cartService.OnChange += StateHasChanged;
    }

    private async Task HandleValidSubmit()
    {
        if (string.IsNullOrWhiteSpace(newReview.Comment)) return;

        using var context = DbFactory.CreateDbContext();
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userName = authState.User.Identity?.IsAuthenticated == true ? authState.User.Identity.Name : "Guest";
        var user = await context.User.FirstOrDefaultAsync(u => u.UserName == userName);

        newReview.BookId = BookId;
        newReview.CreatedAt = DateTime.Now;
        if (user != null) newReview.UserId = user.UserId; else newReview.GuestName = "Guest";

        context.Review.Add(newReview);
        await context.SaveChangesAsync();

        // Adăugăm în lista locală pentru refresh instant
        reviews.Insert(0, newReview);
        await UpdateBookRating(context);

        newReview = new Review() { Rating = 5 }; // Resetare formular
        StateHasChanged();
    }

    private async Task HandleDeleteReview(int reviewId)
    {
        using var context = DbFactory.CreateDbContext();
        var reviewToDelete = await context.Review.FindAsync(reviewId);

        if (reviewToDelete != null)
        {
            context.Review.Remove(reviewToDelete);
            await context.SaveChangesAsync();

            reviews.RemoveAll(x => x.ReviewId == reviewId);
            await UpdateBookRating(context);
            StateHasChanged();
        }
    }

    private async Task UpdateBookRating(BooktiqueContext context)
    {
        var bookToUpdate = await context.Book.FindAsync(BookId);
        if (bookToUpdate != null)
        {
            int newRating = reviews.Any() ? (int)Math.Round(reviews.Average(r => r.Rating)) : 0;
            bookToUpdate.BookRating = newRating;
            if (book != null) book.BookRating = newRating; // Update vizual instant
            await context.SaveChangesAsync();
        }
    }

    private async Task ToggleFavorite()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userName = authState.User.Identity?.Name;
        if (string.IsNullOrEmpty(userName)) return;

        using var context = DbFactory.CreateDbContext();
        var user = await context.User.FirstOrDefaultAsync(u => u.UserName == userName);
        if (user == null) return;

        var favorite = await context.Favorite
            .FirstOrDefaultAsync(f => f.UserId == user.UserId && f.BookId == BookId);

        if (favorite == null)
        {
            context.Favorite.Add(new Favorite { UserId = user.UserId, BookId = BookId });
            isFavorite = true;
        }
        else
        {
            context.Favorite.Remove(favorite);
            isFavorite = false;
        }
        await context.SaveChangesAsync();
    }

    private void HandleAddToCart()
    {
        if (book != null)
        {
            cartService.AddToCart(book);
            isAdded = true;
        }
    }

    public void Dispose() => cartService.OnChange -= StateHasChanged;

    private void NavigateToDetails(int id) => NavigationManager.NavigateTo($"/books/details?bookid={id}", true);
}

