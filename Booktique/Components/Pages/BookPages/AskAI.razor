@page "/ask-ai"
@using Booktique.Models.Services
@using Booktique.Models.MainModels
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@inject AIService AIService
@inject BooktiqueContext Db
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Booktique AI Assistant</PageTitle>

<div class="main-wrapper py-4">
    <div class="container">
        <div class="glass-card ai-main-container shadow-lg border-0">
            <div class="p-3 border-bottom bg-brown text-white rounded-top d-flex align-items-center">
                <div class="ai-avatar me-3">
                    <i class="bi bi-robot"></i>
                </div>
                <div>
                    <h5 class="mb-0 fw-bold">Booktique AI</h5>
                    <small class="opacity-75">Your personal librarian</small>
                </div>
            </div>

            <div class="chat-window p-4" @ref="chatBoxRef">
                <div class="message-container message-left">
                    <div class="message-bubble bubble-other shadow-sm">
                        <span class="message-user">AI Assistant</span>
                        <div class="message-text">Hi! I am your Booktique guidance. I can suggest interesting books for you, exactly according to your wishes. What do you want to read?</div>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(lastInteractionDate))
                {
                    <div class="text-center my-3">
                        <span class="badge bg-light text-muted border">@lastInteractionDate</span>
                    </div>
                }

                @foreach (var message in messages)
                {
                    <div class="message-container @(message.Sender == "user" ? "message-right" : "message-left")">
                        <div class="message-bubble @(message.Sender == "user" ? "bubble-mine shadow-sm" : "bubble-other shadow-sm")">
                            @if (message.Sender != "user")
                            {
                                <span class="message-user">Booktique AI</span>
                            }
                            <div class="message-text">@((MarkupString)message.Text)</div>
                        </div>
                    </div>
                }

                @if (isTyping)
                {
                    <div class="message-container message-left">
                        <div class="message-bubble bubble-other opacity-75 shadow-sm">
                            <div class="typing-dots">
                                <span></span><span></span><span></span>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="p-3 border-top bg-white rounded-bottom">
                <div class="input-group">
                    <input @bind="userQuestion" 
                           @onkeyup="HandleKeyUp" 
                           class="form-control rounded-pill-start border-2 border-end-0 border-light px-4" 
                           placeholder="Type your bookish question here..." />
                    <button class="btn btn-orange rounded-pill-end px-4" @onclick="SubmitQuestion">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    :root {
        --brown-primary: #5a3e2b;
        --orange-accent: #f0a500;
        --chat-bg: #fdf6ee;
    }

    body {
        background-color: var(--chat-bg);
    }

    .ai-main-container {
        height: 75vh;
        min-height: 600px;
        background: white;
        border-radius: 1.5rem;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .bg-brown { background-color: var(--brown-primary) !important; }
    .btn-orange { 
        background-color: var(--orange-accent); 
        color: white; 
        border: none;
        transition: 0.3s;
    }
    .btn-orange:hover { background-color: #d49200; color: white; }

    .ai-avatar {
        width: 45px;
        height: 45px;
        background: rgba(255,255,255,0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .chat-window {
        flex: 1;
        overflow-y: auto;
        background-color: var(--chat-bg);
        display: flex;
        flex-direction: column;
    }

    .message-container { display: flex; margin-bottom: 15px; width: 100%; }
    .message-left { justify-content: flex-start; }
    .message-right { justify-content: flex-end; }

    .message-bubble {
        max-width: 80%;
        padding: 12px 18px;
        border-radius: 1.2rem;
        position: relative;
    }

    .bubble-mine {
        background-color: var(--brown-primary);
        color: white;
        border-bottom-right-radius: 0.2rem;
    }

    .bubble-other {
        background-color: white;
        color: #444;
        border-bottom-left-radius: 0.2rem;
        border: 1px solid #eee;
    }

    .message-user {
        font-size: 0.7rem;
        font-weight: bold;
        color: var(--orange-accent);
        display: block;
        margin-bottom: 4px;
    }

    .rounded-pill-start { border-top-left-radius: 50px; border-bottom-left-radius: 50px; }
    .rounded-pill-end { border-top-right-radius: 50px; border-bottom-right-radius: 50px; }

    .typing-dots span {
        width: 8px;
        height: 8px;
        background: #8d6e63;
        display: inline-block;
        border-radius: 50%;
        margin: 0 2px;
        animation: bounce 1.4s infinite ease-in-out both;
    }
    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

    @@keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }

    .book-card-wrapper {
        margin-top: 10px;
        max-width: 100%;
    }

    .book-card {
        display: flex;
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        text-decoration: none !important;
        color: #333 !important;
        transition: transform 0.2s, box-shadow 0.2s;
        height: 150px; 
    }

        .book-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

    .book-img {
        width: 100px; 
        min-width: 100px; 
        height: 150px; 
        object-fit: cover; 
        border-right: 1px solid #eee;
    }

    .book-info {
        padding: 12px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        overflow: hidden;
    }

    .book-title {
        font-size: 1rem;
        font-weight: bold;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis; /* Taie titlul cu "..." dacă e prea lung */
    }

    .book-author-year {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 8px;
    }

    .book-price {
        font-weight: bold;
        color: var(--brown-primary);
        font-size: 1.1rem;
    }
</style>

<script>
    function scrollToBottom(element) {
        if (element) {
            element.scrollTop = element.scrollHeight;
        }
    }
</script>

@code {
    private string userQuestion = string.Empty;
    private List<(string Sender, string Text)> messages = new();
    private bool isTyping = false;
    private string typingDots = "";
    private CancellationTokenSource? typingToken;
    private ElementReference chatBoxRef;
    private int currentUserId;
    private string? lastInteractionDate;
    private bool hasLoadedHistory = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var idClaim = user.FindFirst("sub") ?? user.FindFirst("nameidentifier");
            if (idClaim != null && int.TryParse(idClaim.Value, out int parsedId))
            {
                currentUserId = parsedId;
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !hasLoadedHistory)
        {
            hasLoadedHistory = true;

            await InvokeAsync(StateHasChanged);
            await ScrollToBottom();
        }
    }

    private async Task SubmitQuestion()
    {
        if (string.IsNullOrWhiteSpace(userQuestion))
            return;

        messages.Add(("user", userQuestion));
        isTyping = true;
        typingDots = "";
        typingToken = new CancellationTokenSource();

        _ = AnimateTypingDots(typingToken.Token);
        await InvokeAsync(StateHasChanged);
        await Task.Delay(1500);

        var response = await AIService.GetRecommendation(userQuestion, currentUserId);

        typingToken.Cancel();
        isTyping = false;
        typingDots = "";

        messages.Add(("ai", response));
        userQuestion = string.Empty;

        lastInteractionDate = DateTime.Now.ToString("dddd, dd MMMM yyyy");

        await InvokeAsync(StateHasChanged);
        await ScrollToBottom();
    }

    private async Task AnimateTypingDots(CancellationToken token)
    {
        var states = new[] { ".", "..", "..." };
        var i = 0;

        while (!token.IsCancellationRequested)
        {
            typingDots = states[i % states.Length];
            i++;
            await InvokeAsync(StateHasChanged);
            await Task.Delay(400);
        }
    }

    private async Task ScrollToBottom()
    {
        await JS.InvokeVoidAsync("scrollToBottom", chatBoxRef);
    }

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await SubmitQuestion();
    }
}
