@page "/books/edit"
@using Microsoft.EntityFrameworkCore
@using Booktique.Models.MainModels
@inject IDbContextFactory<BooktiqueContext> DbFactory
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Edit Book | Booktique</PageTitle>

<div class="main-wrapper py-4">
    <div class="container">
        <div>
            <h2>Edit <strong>@Book?.BookTitle</strong></h2>
            <p class="text-muted small">Update the information below. All changes are permanent.</p>
        </div>
        <hr />

        @if (Book is null)
        {
            <div class="text-center p-5">
                <div class="spinner-border text-warning" role="status"></div>
                <p class="mt-2">Loading book details...</p>
            </div>
        }
        else
        {
            <div class="glass-card shadow-lg border-0 overflow-hidden bg-white">
                <EditForm Model="Book" OnValidSubmit="UpdateBook" FormName="editBook">
                    <DataAnnotationsValidator />

                    <div class="row g-0">
                        @* Coloana de Input-uri *@
                        <div class="col-md-8 p-4 p-md-5 border-end">
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <h5 class="fw-bold text-brown mb-2 border-bottom pb-2">
                                        <i class="bi bi-pencil-square me-2"></i>Book Details
                                    </h5>
                                </div>

                                <div class="col-md-12">
                                    <label class="form-label fw-bold small">Book Title</label>
                                    <InputText @bind-Value="Book.BookTitle" class="form-control rounded-pill px-3" />
                                    <ValidationMessage For="() => Book.BookTitle" class="text-danger small" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">Author</label>
                                    <InputText @bind-Value="Book.BookAuthor" class="form-control rounded-pill px-3" />
                                    <ValidationMessage For="() => Book.BookAuthor" class="text-danger small" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">Category</label>
                                    <InputText @bind-Value="Book.BookCategory" class="form-control rounded-pill px-3" />
                                    <ValidationMessage For="() => Book.BookCategory" class="text-danger small" />
                                </div>

                                <div class="col-md-12">
                                    <label class="form-label fw-bold small">Description</label>
                                    <InputTextArea @bind-Value="Book.BookDescription" class="form-control rounded-3 px-3" rows="3" />
                                    <ValidationMessage For="() => Book.BookDescription" class="text-danger small" />
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label fw-bold small">Price (RON)</label>
                                    <InputNumber @bind-Value="Book.BookPrice" class="form-control rounded-pill px-3" />
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label fw-bold small">Stock</label>
                                    <InputNumber @bind-Value="Book.BookStock" class="form-control rounded-pill px-3" min="0" />
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label fw-bold small">Rating</label>
                                    <InputNumber @bind-Value="Book.BookRating" class="form-control rounded-pill px-3" />
                                </div>

                                <div class="col-md-12">
                                    <label class="form-label fw-bold small">Cover URL</label>
                                    <div class="input-group">
                                        <InputText @bind-Value="Book.BookCoverPath" class="form-control rounded-start-pill px-3" />
                                        <button type="button" class="btn btn-warning rounded-end-pill text-white px-3" @onclick="() => StateHasChanged()">
                                            Preview
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @* Coloana de Preview *@
                        <div class="col-md-4 bg-light d-flex flex-column align-items-center justify-content-center p-4 text-center">
                            <h6 class="text-uppercase fw-bold text-muted mb-4 small">Current Cover</h6>
                            <div class="preview-container shadow-lg mb-3">
                                @if (!string.IsNullOrEmpty(Book.BookCoverPath))
                                {
                                    <img src="@Book.BookCoverPath" class="img-fluid rounded" alt="Cover Preview"
                                         onerror="this.src='https://via.placeholder.com/250x380?text=No+Image';">
                                }
                            </div>
                            <div class="px-2">
                                <h6 class="fw-bold text-brown mb-0">@Book.BookTitle</h6>
                                <p class="small text-muted">ID: #@Book.BookId</p>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-white border-top text-center">
                        <button type="submit" class="btn btn-warning px-5 py-2 rounded-pill fw-bold shadow-sm me-3 text-white">
                            <i class="bi bi-save2-fill me-2"></i>Update Book
                        </button>
                        <a href="/" class="btn btn-outline-secondary px-4 py-2 rounded-pill">Cancel</a>
                    </div>
                </EditForm>
            </div>
        }
    </div>
</div>

<style>
    :root {
        --brown-primary: #5a3e2b;
        --orange-accent: #f0a500;
        --bg-soft: #fdf6ee;
    }

    body {
        background-color: var(--bg-soft);
    }

    .glass-card {
        border-radius: 1.5rem;
    }

    .text-brown {
        color: var(--brown-primary);
    }

    .form-control:focus {
        border-color: var(--orange-accent);
        box-shadow: 0 0 0 0.25rem rgba(240, 165, 0, 0.25);
    }

    .btn-warning {
        background-color: var(--orange-accent);
        border: none;
    }

        .btn-warning:hover {
            background-color: #d69400;
            transform: translateY(-2px);
            transition: 0.2s;
        }

    .preview-container {
        width: 100%;
        max-width: 200px;
        aspect-ratio: 2/3;
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
        border: 2px solid #dee2e6;
    }

        .preview-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
</style>

@code {
    [SupplyParameterFromQuery]
    private int BookId { get; set; }

    private Book? Book { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        Book = await context.Book.FirstOrDefaultAsync(m => m.BookId == BookId);

        if (Book is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
    }

    private async Task UpdateBook()
    {
        if (Book!.BookStock < 0) Book.BookStock = 0; 

        using var context = DbFactory.CreateDbContext();
        context.Attach(Book!).State = EntityState.Modified;

        try
        {
            await context.SaveChangesAsync();
            NavigationManager.NavigateTo($"/books/details?bookid={BookId}");
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!context.Book.Any(e => e.BookId == BookId))
            {
                NavigationManager.NavigateTo("notfound");
            }
            else throw;
        }
    }
}