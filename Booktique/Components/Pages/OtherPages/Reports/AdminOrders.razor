@page "/admin/orders"
@using Booktique.Models.MainModels
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<BooktiqueContext> DbFactory
@rendermode InteractiveServer

<div class="container-fluid py-4 min-vh-100">
    <div class="d-flex justify-content-between align-items-center mb-4 px-3">
        <h2 class="fw-bold text-dark m-0">Order Management</h2>
        <div class="text-muted">Total Orders: @(allOrders?.Count ?? 0)</div>
    </div>

    @if (allOrders == null)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
    }
    else
    {
        <div class="card shadow-sm border-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class=" text-white">
                        <tr>
                            <th class="ps-3">ID</th>
                            <th>Order Date</th>
                            <th>Customer</th>
                            <th>Total Amount</th>
                            <th>Status</th>
                            <th>Change Status</th>
                            <th class="text-end pe-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var order in allOrders)
                        {
                            <tr>
                                <td class="ps-3 fw-bold text-warning">#@order.OrderId</td>
                                <td>@order.OrderDate.ToString("MMM dd, yyyy")</td>
                                <td>
                                    <div class="small fw-bold">User #@order.UserId</div>
                                    <div class="text-muted small">@order.City</div>
                                </td>
                                <td class="fw-bold">@order.TotalAmount.ToString("N2") RON</td>
                                <td>
                                    <span class="badge rounded-pill @GetStatusClass(order.Status)">
                                        @order.Status
                                    </span>
                                </td>
                                <td>
                                    <select class="form-select form-select-sm border-light shadow-sm"
                                            style="width: 140px;"
                                            @onchange="(e) => UpdateStatus(order, e)">
                                        @foreach (var status in Enum.GetValues<OrderStatus>())
                                        {
                                            <option value="@status" selected="@(status == order.Status)">@status</option>
                                        }
                                    </select>
                                </td>
                                <td class="text-end pe-3">
                                    <button class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm" @onclick="() => ShowDetails(order)">
                                        View Details
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@* --- MODERN MODAL --- *@
@if (showModal && selectedOrder != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-white border-bottom-0 pt-4 px-4">
                    <h5 class="modal-title fw-bold">Order Summary #@selectedOrder.OrderId</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body px-4">
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded-3">
                                <h6 class="text-uppercase text-muted small fw-bold">Shipping Info</h6>
                                <p class="mb-0">@selectedOrder.ShippingAddress</p>
                                <p class="mb-0 fw-bold">@selectedOrder.City</p>
                                <p class="mb-0">Tel: @selectedOrder.PhoneNumber</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded-3 h-100">
                                <h6 class="text-uppercase text-muted small fw-bold">Payment & Date</h6>
                                <p class="mb-0">Method: <span class="badge bg-secondary">@selectedOrder.PaymentMethod</span></p>
                                <p class="mb-0">Date: @selectedOrder.OrderDate.ToString("f")</p>
                            </div>
                        </div>
                    </div>

                    <h6 class="fw-bold mb-3">Purchased Items</h6>
                    <div class="table-responsive">
                        <table class="table table-borderless">
                            <thead class="text-muted small border-bottom">
                                <tr>
                                    <th>Item Name</th>
                                    <th class="text-center">Qty</th>
                                    <th class="text-end">Price</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in selectedOrder.OrderItems)
                                {
                                    <tr class="border-bottom-0">
                                        <td class="fw-bold text-dark">@(item.Book?.BookTitle ?? "Digital Product")</td>
                                        <td class="text-center">@item.Quantity</td>
                                        <td class="text-end">@item.UnitPrice.ToString("N2")</td>
                                        <td class="text-end fw-bold">@(item.Quantity * item.UnitPrice) RON</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer bg-light border-0 py-3 px-4 rounded-bottom">
                    <div class="me-auto">
                        <span class="text-muted">Total: </span>
                        <span class="h4 fw-bold text-warning mb-0">@selectedOrder.TotalAmount.ToString("N2") RON</span>
                    </div>
                    <button type="button" class="btn btn-secondary rounded-pill px-4" @onclick="CloseModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    body {
        background-color: #fdf6ee !important;
        font-family: 'Inter', 'Segoe UI', sans-serif !important;
    }

    .card {
        border-radius: 12px;
        overflow: hidden;
    }

    .table thead th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        padding-top: 15px;
        padding-bottom: 15px;
    }

    .badge {
        font-weight: 500;
        padding: 0.5em 0.8em;
    }

    .form-select-sm {
        border-radius: 8px;
        font-size: 0.85rem;
    }

    .modal-content {
        border-radius: 16px;
    }

    .btn-primary {
        background-color: #f0a500;
        border: none;
    }

        .btn-primary:hover {
            background-color: #f0a500;
            transform: translateY(-1px);
        }
</style>

@code {
    private List<Order>? allOrders;
    private Order? selectedOrder;
    private bool showModal = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        using var context = DbFactory.CreateDbContext();
        allOrders = await context.Order
            .OrderByDescending(o => o.OrderDate)
            .ToListAsync();
    }

    private async Task ShowDetails(Order order)
    {
        using var context = DbFactory.CreateDbContext();
        selectedOrder = await context.Order
            .Include(o => o.OrderItems)
                .ThenInclude(oi => oi.Book)
            .FirstOrDefaultAsync(o => o.OrderId == order.OrderId);

        if (selectedOrder != null) showModal = true;
    }

    private void CloseModal() { showModal = false; selectedOrder = null; }

    private string GetStatusClass(OrderStatus status) => status switch
    {
        OrderStatus.Pending => "bg-warning-subtle text-warning-emphasis border border-warning",
        OrderStatus.Confirmed => "bg-info-subtle text-info-emphasis border border-info",
        OrderStatus.Shipped => "bg-primary-subtle text-primary-emphasis border border-primary",
        OrderStatus.Delivered => "bg-success-subtle text-success-emphasis border border-success",
        OrderStatus.Cancelled => "bg-danger-subtle text-danger-emphasis border border-danger",
        _ => "bg-secondary-subtle text-secondary-emphasis"
    };

    private async Task UpdateStatus(Order order, ChangeEventArgs e)
    {
        if (Enum.TryParse<OrderStatus>(e.Value?.ToString(), out var newStatus))
        {
            using var context = await DbFactory.CreateDbContextAsync();

            // 1. Găsim comanda în baza de date
            var dbOrder = await context.Order.FindAsync(order.OrderId);

            if (dbOrder != null)
            {
                // 2. Actualizăm statusul comenzii
                dbOrder.Status = newStatus;
                dbOrder.LastUpdated = DateTime.Now;

                // 3. Creăm NOTIFICAREA pentru utilizator (UserId-ul vine din comanda găsită)
                var notification = new Notification
                    {
                        UserId = dbOrder.UserId, // Important: ID-ul clientului
                        Message = $"Statusul comenzii tale #{dbOrder.OrderId} a fost actualizat în: {newStatus}.",
                        CreatedAt = DateTime.Now,
                        IsRead = false,
                        TargetUrl = "/my-orders"
                    };

                context.Notification.Add(notification);

                // 4. Salvăm totul într-o singură tranzacție
                await context.SaveChangesAsync();

                // 5. Actualizăm interfața Adminului (UI local)
                order.Status = newStatus;
                StateHasChanged();
            }
        }
    }
}